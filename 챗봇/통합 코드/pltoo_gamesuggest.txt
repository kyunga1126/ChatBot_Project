# ê²Œì„ ì¶”ì²œ ê¸°ëŠ¥_step1_í˜„ì¤€

# mysqlclient ì„¤ì¹˜í•˜ì—¬ MySQLdb í˜¸ì¶œ
import pymysql
import random

# flaskì— ìˆëŠ” requestì™€ Bluepoint í˜¸ì¶œ
from flask import Blueprint, request, Flask, jsonify

# MySQL ê°ì²´ ë“±ë¡
conn = pymysql.connect(
    host="52.78.100.77",
    port=54201,
    db='friendly',
    user='root',
    password='12345',
    charset='utf8mb4',
    cursorclass=pymysql.cursors.DictCursor
)

# ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
step1_platform = None
step2_players = None
step3_difficulty = None
step4_category = None

# ë¸”ë£¨í”„ë¦°íŠ¸ ê°ì²´ ë“±ë¡
bp = Blueprint('pltoo_gamesuggest', __name__, url_prefix='/')

@bp.route('/step1_gamesuggest', methods=['POST'])
def step1_gamesuggest():
    body = request.get_json()
    
    response = {
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "textCard": {
          "title": "ì–´ëŠ í”Œë«í¼ì—ì„œ ê²Œì„ì„ ì¦ê¸°ì‹œë‚˜ìš”?",
          "description": "PC, ëª¨ë°”ì¼ ì¤‘ ì„ íƒí•´ì£¼ì„¸ìš”.",
          "buttons": [
            {
              "action": "message",
              "label": "ğŸ“ŸPCì—ì„œ ì£¼ë¡œ í•´ìš”",
              "messageText": "PC"
            },
            {
              "action": "message",
              "label": "ğŸ“±ëª¨ë°”ì¼ì—ì„œ ì£¼ë¡œ í•´ìš”",
              "messageText": "ëª¨ë°”ì¼"
            }
          ]
        }
      }
    ]
  }
}
    return jsonify(response)

# ------------------------------------------------------------------------------------------------------------------------------
@bp.route('/step2_gamesuggest', methods=['POST'])
def step2_gamesuggest():
    global step1_platform
    body = request.get_json()
    
    # 'utterance' ê°’ ê°€ì ¸ì˜¤ê¸°
    step1_platform = body['userRequest']['utterance']
    print(f'step1_platform : {step1_platform}')
    
    response = {
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "textCard": {
          "title": "í˜¼ì í•˜ì‹œë‚˜ìš”, ì•„ë‹ˆë©´ ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ í•˜ì‹œë‚˜ìš”?",
          "buttons": [
            {
              "action": "message",
              "label": "â˜í˜¼ì ê²Œì„í•˜ê¸°",
              "messageText": "í˜¼ì"
            },
            {
              "action": "message",
              "label": "âœŒì¹œêµ¬ë“¤ê³¼ í•¨ê»˜",
              "messageText": "ë‹¤ì¤‘"
            }
          ]
        }
      }
    ]
  }
}
    return jsonify(response)

# -------------------------------------------------------------------------------------------------------------------------------------
@bp.route('/step3_gamesuggest', methods=['POST'])
def step3_gamesuggest():
    global step2_players
    body = request.get_json()
    
    # 'utterance' ê°’ ê°€ì ¸ì˜¤ê¸°
    step2_players = body['userRequest']['utterance']
    print(f'step2_players : {step2_players}')
    
    response = {
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "textCard": {
          "title": "ê²Œì„ì˜ ë‚œì´ë„ëŠ” ì–´ëŠ ì •ë„ë¥¼ ì›í•˜ì‹œë‚˜ìš”?",
          "description": "ì‰¬ì›€, ë³´í†µ, ì–´ë ¤ì›€ ì¤‘ ì„ íƒí•´ì£¼ì„¸ìš”",
          "buttons": [
            {
              "action": "message",
              "label": "ğŸ˜Šì‰¬ì›€ ë‚œì´ë„ë¡œìš”.",
              "messageText": "ì‰¬ì›€"
            },
            {
              "action": "message",
              "label": "ğŸ˜ë³´í†µ ë‚œì´ë„ë¡œìš”.",
              "messageText": "ë³´í†µ"
            },
            {
              "action": "message",
              "label": "ğŸ¤¬ì–´ë ¤ì›€ ë‚œì´ë„ë¡œìš”.",
              "messageText": "ì–´ë ¤ì›€"
            }
          ]
        }
      }
    ]
  }
}
    return jsonify(response)
# -------------------------------------------------------------------------------------------------------------------------------------
@bp.route('/step4_gamesuggest', methods=['POST'])
def step4_gamesuggest():
    global step3_difficulty
    body = request.get_json()
    
    # 'utterance' ê°’ ê°€ì ¸ì˜¤ê¸°
    step3_difficulty = body['userRequest']['utterance']
    print(f'step3_difficulty : {step3_difficulty}')
    
    response = {
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "carousel": {
          "type": "basicCard",
          "items": [
            {
              "title": "ì–´ë–¤ ì¥ë¥´ì˜ ê²Œì„ì„ ì„ í˜¸í•˜ì‹œë‚˜ìš”?",
              "thumbnail": {
                "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FBjhPu%2FbtsHzDCsgQ2%2F5TaUxGxVbNT4OUFzoWE5d0%2Fimg.jpg"
              },
              "buttons": [
                {
                  "action": "message",
                  "label": "ğŸ¤¼â€â™‚ï¸ì•¡ì…˜",
                  "messageText": "ì•¡ì…˜"
                },
                {
                  "action":  "message",
                  "label": "ğŸ—»ì–´ë“œë²¤ì²˜",
                  "messageText": "ì–´ë“œë²¤ì²˜"
                },
                {
                  "action":  "message",
                  "label": "ğŸ„RPG",
                  "messageText": "RPG"
                }
              ]
            },
            {
              "title": "ì–´ë–¤ ì¥ë¥´ì˜ ê²Œì„ì„ ì„ í˜¸í•˜ì‹œë‚˜ìš”?",
              "thumbnail": {
                "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbMo4yv%2FbtsHANjLtIz%2FrIjhFWDvI2xMqqiyIOthq0%2Fimg.jpg"
              },
              "buttons": [
                {
                  "action": "message",
                  "label": "ğŸ²í¼ì¦",
                  "messageText": "í¼ì¦"
                },
                {
                  "action":  "message",
                  "label": "âš½ìŠ¤í¬ì¸ ",
                  "messageText": "ìŠ¤í¬ì¸ "
                },
                {
                  "action":  "message",
                  "label": "ğŸ”«ìŠˆíŒ…",
                  "messageText": "ìŠˆíŒ…"
                }
              ]
            }
          ]
        }
      }
    ]
  }
}
    return jsonify(response)
# -------------------------------------------------------------------------------------------------------------------------------------
@bp.route('/step5_gamesuggest', methods=['POST'])
def step5_gamesuggest():
    global step1_platform, step2_players, step3_difficulty, step4_category, conn
    body = request.get_json()

    # 'utterance' ê°’ ê°€ì ¸ì˜¤ê¸°
    step4_category = body['userRequest']['utterance']
    print(f'step4_category : {step4_category}')

    # SQLë¬¸
    cursor = conn.cursor()
    sql = "SELECT * FROM gamesuggest WHERE platform = %s AND players = %s AND game_difficulty = %s AND game_category = %s"
    cursor.execute(sql, (step1_platform, step2_players, step3_difficulty, step4_category))
    suppliers = cursor.fetchall()

    # í„°ë¯¸ë„ ì¶œë ¥ í™•ì¸ìš©
    for supplier in suppliers:
        print(supplier)

    random_suppliers = random.sample(suppliers, k=3)  # suppliers ë¦¬ìŠ¤íŠ¸ì—ì„œ ëœë¤í•˜ê²Œ 3ê°œì˜ í•­ëª©ì„ ì„ íƒ

    response = {
        "version": "2.0",
        "template": {
            "outputs": [
                {
                "simpleText": {
                    "text": f"ì•Œê² ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë©´ {step1_platform}ì—ì„œ {step2_players} ì¦ê¸¸ ìˆ˜ ìˆëŠ” {step3_difficulty} ë‚œì´ë„ì˜ {step4_category} ê²Œì„ì„ ì¶”ì²œí•´ë“œë¦´ê²Œìš”."
                }
            },
            {
                    "carousel": {
                        "type": "basicCard",
                        "items": [
                            {
                                "title": random_suppliers[0]['game_name'],
                                "description": f"í”Œë«í¼: {random_suppliers[0]['platform']}, ì¥ë¥´: {random_suppliers[0]['game_category']}, ë‚œì´ë„: {random_suppliers[0]['game_difficulty']}",
                                "thumbnail": {
                                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2F5is5P%2FbtsHAwvMMz5%2FyzYPVs9ywZG1cxz2bMraL0%2Fimg.png"
                                },
                                "buttons": [
                                    {
                                        "action": "webLink",
                                        "label": "ë‹¤ìš´ë¡œë“œ",
                                        "messageText": "https://chatbot.kakao.com/docs/getting-started-overview/"
                                    },
                                    {
                                        "action":  "webLink",
                                        "label": "ê²Œì„ ì‚¬ì´íŠ¸",
                                        "webLinkUrl": "https://e.kakao.com/t/hello-ryan"
                                    }
                                ]
                            },
                            {
                                "title": random_suppliers[1]['game_name'],
                                "description": f"í”Œë«í¼: {random_suppliers[1]['platform']}, ì¥ë¥´: {random_suppliers[1]['game_category']}, ë‚œì´ë„: {random_suppliers[1]['game_difficulty']}",
                                "thumbnail": {
                                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdlFnmf%2FbtsHzck2Nnj%2FAaN4sQu8NJQI521KIIpGIK%2Fimg.png"
                                },
                                "buttons": [
                                    {
                                        "action": "webLink",
                                        "label": "ë‹¤ìš´ë¡œë“œ",
                                        "messageText": "https://chatbot.kakao.com/docs/getting-started-overview/"
                                    },
                                    {
                                        "action":  "webLink",
                                        "label": "ê²Œì„ ì‚¬ì´íŠ¸",
                                        "webLinkUrl": "https://e.kakao.com/t/hello-ryan"
                                    }
                                ]
                            },
                            {
                                "title": random_suppliers[2]['game_name'],
                                "description": f"í”Œë«í¼: {random_suppliers[2]['platform']}, ì¥ë¥´: {random_suppliers[2]['game_category']}, ë‚œì´ë„: {random_suppliers[2]['game_difficulty']}",
                                "thumbnail": {
                                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fbz918Y%2FbtsHz7J4CBY%2Fm3vQCTxHSjqEz12eKfNEiK%2Fimg.png"
                                },
                                "buttons": [
                                    {
                                        "action": "webLink",
                                        "label": "ë‹¤ìš´ë¡œë“œ",
                                        "messageText": "https://chatbot.kakao.com/docs/getting-started-overview/"
                                    },
                                    {
                                        "action":  "webLink",
                                        "label": "ê²Œì„ ì‚¬ì´íŠ¸",
                                        "webLinkUrl": "https://e.kakao.com/t/hello-ryan"
                                    }
                                ]
                            }
                        ]
                    }
                }
            ],
            "quickReplies": [
              {
                "messageText": "ì²˜ìŒìœ¼ë¡œ",
                "action": "message",
                "label": "ì²˜ìŒìœ¼ë¡œ"
              },
              {
                "messageText": "ë‹¤ì‹œ ê²Œì„ ì¶”ì²œ ë°›ê¸°",
                "action": "message",
                "label": "ë‹¤ì‹œ ê²Œì„ ì¶”ì²œ ë°›ê¸°"
              }
            ]
        }
    }
    # JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜
    return jsonify(response)