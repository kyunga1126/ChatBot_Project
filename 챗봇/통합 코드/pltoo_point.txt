# ê²Œì„ ì¶”ì²œ ê¸°ëŠ¥_step1_í˜„ì¤€

# mysqlclient ì„¤ì¹˜í•˜ì—¬ MySQLdb í˜¸ì¶œ
import pymysql
import random

# flaskì— ìˆëŠ” requestì™€ Bluepoint í˜¸ì¶œ
from flask import Blueprint, request, Flask, jsonify

# MySQL ê°ì²´ ë“±ë¡
conn = pymysql.connect(
    host="52.78.100.77",
    port=54201,
    db='friendly',
    user='root',
    password='12345',
    charset='utf8mb4',
    cursorclass=pymysql.cursors.DictCursor
)

# ë¸”ë£¨í”„ë¦°íŠ¸ ê°ì²´ ë“±ë¡
bp = Blueprint('pltoo_point', __name__, url_prefix='/')
# ------------------------------------------------------------------------------------------------------------------------------
# ë“±ê¸‰ë³„ ì‚¬ìš©ì ì¡°íšŒ í•¨ìˆ˜
@bp.route('/step1_point', methods=['POST'])
def step1_point():
    body = request.get_json()

    # 'utterance' ê°’ ê°€ì ¸ì˜¤ê¸°
    rank = body['userRequest']['utterance']
    print(f'ì‚¬ìš©ì ë“±ê¸‰ì€ : {rank}')

    response = {
      "version": "2.0",
      "template": {
        "outputs": [
          {
            "carousel": {
              "type": "basicCard",
              "items": [
                {
                  "title": "ì¡°íšŒí•  ë“±ê¸‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.",
                  "thumbnail": {
                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdAqmkb%2FbtsHBpCK2sR%2F5f2REVwRSQkiJ3qWkAcZkK%2Fimg.png"
                  },
                  "buttons": [
                    {
                      "action": "message",
                      "label": "ğŸ’VIP",
                      "messageText": "VIP"
                    },
                    {
                      "action":  "message",
                      "label": "ğŸ¥‡ê³¨ë“œ",
                      "messageText": "ê³¨ë“œ"
                    }
                  ]
                },
                {
                  "title": "ì¡°íšŒí•  ë“±ê¸‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.",
                  "thumbnail": {
                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdAqmkb%2FbtsHBpCK2sR%2F5f2REVwRSQkiJ3qWkAcZkK%2Fimg.png"
                  },
                  "buttons": [
                    {
                      "action": "message",
                      "label": "ğŸ¥ˆì‹¤ë²„",
                      "messageText": "ì‹¤ë²„"
                    },
                    {
                      "action":  "message",
                      "label": "ğŸ¥‰ë¸Œë¡ ì¦ˆ",
                      "messageText": "ë¸Œë¡ ì¦ˆ"
                    }
                  ]
                }
              ]
            }
          }
        ]
      }
    }
    return jsonify(response)

# ------------------------------------------------------------------------------------------------------------------------------
@bp.route('/step2_point', methods=['POST'])
def step2_point():
    body = request.get_json()
    
    # 'utterance' ê°’ ê°€ì ¸ì˜¤ê¸°
    rank = body['userRequest']['utterance']
    print(f'ì‚¬ìš©ì ë“±ê¸‰ì€ : {rank}')

    # SQLë¬¸
    cursor = conn.cursor()
     # ë‚˜ì´ëŒ€ë¥¼ í‚¤(key)ë¡œ í•˜ê³ , ê° ë‚˜ì´ëŒ€ì— ëŒ€í•œ SQL ì¡°ê±´ë¬¸ì„ ê°’(value)ìœ¼ë¡œ ê°–ê³ ìˆë‹¤.
    sql = {
        'ë¸Œë¡ ì¦ˆ': "SELECT * FROM class WHERE point < 500",
        'ì‹¤ë²„': "SELECT * FROM class WHERE point >= 500 AND point < 1000",
        'ê³¨ë“œ': "SELECT * FROM class WHERE point >= 1000 AND point < 1500",
        'VIP': "SELECT * FROM class WHERE point >= 1500"
    }.get(rank, 'point < 0')
    print(f'ì™„ì„±ëœ sqlë¬¸ì€ {sql}')
    cursor.execute(sql)
    suppliers = cursor.fetchall()

    # í„°ë¯¸ë„ ì¶œë ¥ í™•ì¸ìš©
    for supplier in suppliers:
        print(supplier)

    # suppliers ë¦¬ìŠ¤íŠ¸ì—ì„œ ëœë¤í•˜ê²Œ 3ê°œì˜ í•­ëª©ì„ ì„ íƒ
    random_suppliers = random.sample(suppliers, k=3)

    response = {
      "version": "2.0",
      "template": {
        "outputs": [
          {
            "carousel": {
              "type": "listCard",
              "items": [
                {
                  "header": {
                    "title": f"íšŒì› ë“±ê¸‰ : {rank}"
                  },
                  "items": [
                    {
                      "title": random_suppliers[0]['name'],
                      "description": f"í¬ì¸íŠ¸ : {random_suppliers[0]['point']}",
                      "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdAqmkb%2FbtsHBpCK2sR%2F5f2REVwRSQkiJ3qWkAcZkK%2Fimg.png"
                    },
                    {
                      "title": random_suppliers[1]['name'],
                      "description": f"í¬ì¸íŠ¸ : {random_suppliers[1]['point']}",
                      "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdAqmkb%2FbtsHBpCK2sR%2F5f2REVwRSQkiJ3qWkAcZkK%2Fimg.png"
                    },
                    {
                      "title": random_suppliers[2]['name'],
                      "description": f"í¬ì¸íŠ¸ : {random_suppliers[2]['point']}",
                      "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdAqmkb%2FbtsHBpCK2sR%2F5f2REVwRSQkiJ3qWkAcZkK%2Fimg.png"
                    }
                  ]
                }
              ]
            }
          }
        ],
        "quickReplies": [
          {
            "messageText": "ì²˜ìŒìœ¼ë¡œ",
            "action": "message",
            "label": "ì²˜ìŒìœ¼ë¡œ"
          },
          {
            "messageText": "ë‹¤ì‹œ í¬ì¸íŠ¸ ì¡°íšŒí•˜ê¸°",
            "action": "message",
            "label": "ë‹¤ì‹œ í¬ì¸íŠ¸ ì¡°íšŒí•˜ê¸°"
          }
        ]
      }
    }
    return jsonify(response)