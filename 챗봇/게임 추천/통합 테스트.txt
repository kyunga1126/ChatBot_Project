from flask import Flask, request, jsonify
import pymysql
import random

# Database connection setup
conn = pymysql.connect(
    host="13.124.40.13", 
    port=53365, 
    db='friendly', 
    user='root', 
    password='12345',
    charset='utf8mb4',
    cursorclass=pymysql.cursors.DictCursor
)


application = Flask(__name__)

# Ï†ÑÏó≠ Î≥ÄÏàò ÏÑ†Ïñ∏
step1_platform = None
step2_players = None
step3_difficulty = None
step4_category = None

gender = None
age_group = None

# ----------------------------------------------------------------------------------------------------
# ÏãúÏûë ÏΩîÎìú
@application.route('/start', methods=['POST'])
def start():
    body = request.get_json()

    response = {
        "version": "2.0",
        "template": {
            "outputs": [ 
            {
                    "carousel": {
                        "type": "basicCard",
                        "items": [
                            {
                                "title": "ÏïàÎÖïÌïòÏÑ∏Ïöî! ÌîåÌà¨ Ï±óÎ¥áÏûÖÎãàÎã§.",
                                "description": "Îã§ÏñëÌïú Í∏∞Îä•Îì§ÏùÑ Ï†úÍ≥µÌïòÍ≥† ÏûàÏäµÎãàÎã§. \nÏñ¥Îñ§ Í∏∞Îä•ÏùÑ ÏõêÌïòÏãúÎÇòÏöî?",
                                "thumbnail": {
                                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FTZh2C%2FbtsHzbNga9I%2FuLbymZLQ1J5s0svYBur0WK%2Fimg.png"
                                },
                                "buttons": [
                                    {
                                        "action": "message",
                                        "label": "ÏπúÍµ¨ Ï∞æÍ∏∞",
                                        "messageText": "ÏπúÍµ¨ Ï∞æÍ∏∞"
                                    },
                                    {
                                        "action":  "message",
                                        "label": "Í≤åÏûÑ Ï∂îÏ≤ú Î∞õÍ∏∞",
                                        "messageText": "Í≤åÏûÑ Ï∂îÏ≤ú Î∞õÍ∏∞"
                                    },
                                    {
                                        "action":  "message",
                                        "label": "Ìè¨Ïù∏Ìä∏ Ï°∞Ìöå",
                                        "messageText": "Ìè¨Ïù∏Ìä∏ Ï°∞Ìöå"
                                    }
                                ]
                            },
                            {
                                "title": "ÏïàÎÖïÌïòÏÑ∏Ïöî! ÌîåÌà¨ Ï±óÎ¥áÏûÖÎãàÎã§.",
                                "description": "Îã§ÏñëÌïú Í∏∞Îä•Îì§ÏùÑ Ï†úÍ≥µÌïòÍ≥† ÏûàÏäµÎãàÎã§. \nÏñ¥Îñ§ Í∏∞Îä•ÏùÑ ÏõêÌïòÏãúÎÇòÏöî?",
                                "thumbnail": {
                                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fbolvbc%2FbtsHy9WaW9J%2F564XDZ8ezXAZp7JL9TP9kK%2Fimg.png"
                                },
                                "buttons": [
                                    {
                                        "action": "message",
                                        "label": "ÏûêÏ£º Î¨ªÎäî ÏßàÎ¨∏ Î≥¥Í∏∞",
                                        "messageText": "ÏûêÏ£º Î¨ªÎäî ÏßàÎ¨∏ Î≥¥Í∏∞"
                                    },
                                    {
                                        "action":  "message",
                                        "label": "Î¨∏Ïùò Î∞è Ïã†Í≥† ÌïòÍ∏∞",
                                        "messageText": "Î¨∏Ïùò Î∞è Ïã†Í≥† ÌïòÍ∏∞"
                                    }
                                ]
                            }
                        ]
                    }
                }
            ]
        }
    }
    return jsonify(response)
# ----------------------------------------------------------------------------------------------------
# Í≤åÏûÑ Ï∂îÏ≤ú step1
@application.route('/step1_gamesuggest', methods=['POST'])
def step1_gamesuggest():
    body = request.get_json()
    
    response = {
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "textCard": {
          "title": "Ïñ¥Îäê ÌîåÎû´ÌèºÏóêÏÑú Í≤åÏûÑÏùÑ Ï¶êÍ∏∞ÏãúÎÇòÏöî?",
          "description": "PC, Î™®Î∞îÏùº Ï§ë ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.",
          "buttons": [
            {
              "action": "message",
              "label": "PCÏóêÏÑú Ï£ºÎ°ú Ìï¥Ïöî.",
              "messageText": "PC"
            },
            {
              "action": "message",
              "label": "Î™®Î∞îÏùºÏóêÏÑú Ï£ºÎ°ú Ìï¥Ïöî.",
              "messageText": "Î™®Î∞îÏùº"
            }
          ]
        }
      }
    ]
  }
}
    return jsonify(response)
# ----------------------------------------------------------------------------------------------------
# Í≤åÏûÑ Ï∂îÏ≤ú step2
@application.route('/step2_gamesuggest', methods=['POST'])
def step2_gamesuggest():
    global step1_platform
    body = request.get_json()
    
    # 'utterance' Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
    step1_platform = body['userRequest']['utterance']
    print(f'step1_platform : {step1_platform}')
    
    response = {
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "textCard": {
          "title": "ÌòºÏûê ÌïòÏãúÎÇòÏöî, ÏïÑÎãàÎ©¥ ÏπúÍµ¨Îì§Í≥º Ìï®Íªò ÌïòÏãúÎÇòÏöî?",
          "buttons": [
            {
              "action": "message",
              "label": "ÌòºÏûê Í≤åÏûÑÌïòÍ∏∞",
              "messageText": "ÌòºÏûê"
            },
            {
              "action": "message",
              "label": "ÏπúÍµ¨Îì§Í≥º Ìï®Íªò",
              "messageText": "Îã§Ï§ë"
            }
          ]
        }
      }
    ]
  }
}
    return jsonify(response)
# ----------------------------------------------------------------------------------------------------
# Í≤åÏûÑ Ï∂îÏ≤ú step3
@application.route('/step3_gamesuggest', methods=['POST'])
def step3_gamesuggest():
    global step2_players
    body = request.get_json()
    
    # 'utterance' Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
    step2_players = body['userRequest']['utterance']
    print(f'step2_players : {step2_players}')
    
    response = {
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "textCard": {
          "title": "Í≤åÏûÑÏùò ÎÇúÏù¥ÎèÑÎäî Ïñ¥Îäê Ï†ïÎèÑÎ•º ÏõêÌïòÏãúÎÇòÏöî?",
          "description": "Ïâ¨ÏõÄ, Î≥¥ÌÜµ, Ïñ¥Î†§ÏõÄ Ï§ë ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî",
          "buttons": [
            {
              "action": "message",
              "label": "Ïâ¨ÏõÄ ÎÇúÏù¥ÎèÑÎ°úÏöî.",
              "messageText": "Ïâ¨ÏõÄ"
            },
            {
              "action": "message",
              "label": "Î≥¥ÌÜµ ÎÇúÏù¥ÎèÑÎ°úÏöî.",
              "messageText": "Î≥¥ÌÜµ"
            },
            {
              "action": "message",
              "label": "Ïñ¥Î†§ÏõÄ ÎÇúÏù¥ÎèÑÎ°úÏöî.",
              "messageText": "Ïñ¥Î†§ÏõÄ"
            }
          ]
        }
      }
    ]
  }
}
    return jsonify(response)
# ----------------------------------------------------------------------------------------------------
# Í≤åÏûÑ Ï∂îÏ≤ú step4_Ïû•Î•¥
@application.route('/step4_gamesuggest', methods=['POST'])
def step4_gamesuggest():
    global step3_difficulty
    body = request.get_json()
    
    # 'utterance' Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
    step3_difficulty = body['userRequest']['utterance']
    print(f'step3_difficulty : {step3_difficulty}')
    
    response = {
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "carousel": {
          "type": "basicCard",
          "items": [
            {
              "title": "Ïñ¥Îñ§ Ïû•Î•¥Ïùò Í≤åÏûÑÏùÑ ÏÑ†Ìò∏ÌïòÏãúÎÇòÏöî?",
              "thumbnail": {
                "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FBjhPu%2FbtsHzDCsgQ2%2F5TaUxGxVbNT4OUFzoWE5d0%2Fimg.jpg"
              },
              "buttons": [
                {
                  "action": "message",
                  "label": "Ïï°ÏÖò",
                  "messageText": "Ïï°ÏÖò"
                },
                {
                  "action":  "message",
                  "label": "Ïñ¥ÎìúÎ≤§Ï≤ò",
                  "messageText": "Ïñ¥ÎìúÎ≤§Ï≤ò"
                },
                {
                  "action":  "message",
                  "label": "RPG",
                  "messageText": "RPG"
                }
              ]
            },
            {
              "title": "Ïñ¥Îñ§ Ïû•Î•¥Ïùò Í≤åÏûÑÏùÑ ÏÑ†Ìò∏ÌïòÏãúÎÇòÏöî?",
              "thumbnail": {
                "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbMo4yv%2FbtsHANjLtIz%2FrIjhFWDvI2xMqqiyIOthq0%2Fimg.jpg"
              },
              "buttons": [
                {
                  "action": "message",
                  "label": "ÌçºÏ¶ê",
                  "messageText": "ÌçºÏ¶ê"
                },
                {
                  "action":  "message",
                  "label": "Ïä§Ìè¨Ï∏†",
                  "messageText": "Ïä§Ìè¨Ï∏†"
                },
                {
                  "action":  "message",
                  "label": "ÏäàÌåÖ",
                  "messageText": "ÏäàÌåÖ"
                }
              ]
            }
          ]
        }
      }
    ]
  }
}
    return jsonify(response)

# ----------------------------------------------------------------------------------------------------
# Í≤åÏûÑ Ï∂îÏ≤ú step5_SQLÎ¨∏ Î∞òÌôòÌïòÍ∏∞
@application.route('/step5_gamesuggest', methods=['POST'])
def step5_gamesuggest():
    global step1_platform, step2_players, step3_difficulty, step4_category, conn
    body = request.get_json()

    # 'utterance' Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
    step4_category = body['userRequest']['utterance']
    print(f'step4_category : {step4_category}')

    # SQLÎ¨∏
    cursor = conn.cursor()
    sql = "SELECT * FROM gamesuggest WHERE platform = %s AND players = %s AND game_difficulty = %s AND game_category = %s"
    cursor.execute(sql, (step1_platform, step2_players, step3_difficulty, step4_category))
    suppliers = cursor.fetchall()

    # ÌÑ∞ÎØ∏ÎÑê Ï∂úÎ†• ÌôïÏù∏Ïö©
    for supplier in suppliers:
        print(supplier)

    random_suppliers = random.sample(suppliers, k=3)  # suppliers Î¶¨Ïä§Ìä∏ÏóêÏÑú ÎûúÎç§ÌïòÍ≤å 3Í∞úÏùò Ìï≠Î™©ÏùÑ ÏÑ†ÌÉù

    game_dict = {
        "version": "2.0",
        "template": {
            "outputs": [
                {
                "simpleText": {
                    "text": f"ÏïåÍ≤†ÏäµÎãàÎã§. Í∑∏Îü¨Î©¥ {step1_platform}ÏóêÏÑú {step2_players} Ï¶êÍ∏∏ Ïàò ÏûàÎäî {step3_difficulty} ÎÇúÏù¥ÎèÑÏùò {step4_category} Í≤åÏûÑÏùÑ Ï∂îÏ≤úÌï¥ÎìúÎ¶¥Í≤åÏöî."
                }
            },
            {
                    "carousel": {
                        "type": "basicCard",
                        "items": [
                            {
                                "title": random_suppliers[0]['game_name'],
                                "description": f"ÌîåÎû´Ìèº: {random_suppliers[0]['platform']}, Ïû•Î•¥: {random_suppliers[0]['game_category']}, ÎÇúÏù¥ÎèÑ: {random_suppliers[0]['game_difficulty']}",
                                "thumbnail": {
                                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2F5is5P%2FbtsHAwvMMz5%2FyzYPVs9ywZG1cxz2bMraL0%2Fimg.png"
                                },
                                "buttons": [
                                    {
                                        "action": "webLink",
                                        "label": "Îã§Ïö¥Î°úÎìú",
                                        "messageText": "https://chatbot.kakao.com/docs/getting-started-overview/"
                                    },
                                    {
                                        "action":  "webLink",
                                        "label": "Í≤åÏûÑ ÏÇ¨Ïù¥Ìä∏",
                                        "webLinkUrl": "https://e.kakao.com/t/hello-ryan"
                                    }
                                ]
                            },
                            {
                                "title": random_suppliers[1]['game_name'],
                                "description": f"ÌîåÎû´Ìèº: {random_suppliers[1]['platform']}, Ïû•Î•¥: {random_suppliers[1]['game_category']}, ÎÇúÏù¥ÎèÑ: {random_suppliers[1]['game_difficulty']}",
                                "thumbnail": {
                                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdlFnmf%2FbtsHzck2Nnj%2FAaN4sQu8NJQI521KIIpGIK%2Fimg.png"
                                },
                                "buttons": [
                                    {
                                        "action": "webLink",
                                        "label": "Îã§Ïö¥Î°úÎìú",
                                        "messageText": "https://chatbot.kakao.com/docs/getting-started-overview/"
                                    },
                                    {
                                        "action":  "webLink",
                                        "label": "Í≤åÏûÑ ÏÇ¨Ïù¥Ìä∏",
                                        "webLinkUrl": "https://e.kakao.com/t/hello-ryan"
                                    }
                                ]
                            },
                            {
                                "title": random_suppliers[2]['game_name'],
                                "description": f"ÌîåÎû´Ìèº: {random_suppliers[2]['platform']}, Ïû•Î•¥: {random_suppliers[2]['game_category']}, ÎÇúÏù¥ÎèÑ: {random_suppliers[2]['game_difficulty']}",
                                "thumbnail": {
                                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fbz918Y%2FbtsHz7J4CBY%2Fm3vQCTxHSjqEz12eKfNEiK%2Fimg.png"
                                },
                                "buttons": [
                                    {
                                        "action": "webLink",
                                        "label": "Îã§Ïö¥Î°úÎìú",
                                        "messageText": "https://chatbot.kakao.com/docs/getting-started-overview/"
                                    },
                                    {
                                        "action":  "webLink",
                                        "label": "Í≤åÏûÑ ÏÇ¨Ïù¥Ìä∏",
                                        "webLinkUrl": "https://e.kakao.com/t/hello-ryan"
                                    }
                                ]
                            }
                        ]
                    }
                }
            ],
            "quickReplies": [
              {
                "messageText": "Ï≤òÏùåÏúºÎ°ú",
                "action": "message",
                "label": "Ï≤òÏùåÏúºÎ°ú"
              },
              {
                "messageText": "Îã§Ïãú Í≤åÏûÑ Ï∂îÏ≤ú Î∞õÍ∏∞",
                "action": "message",
                "label": "Îã§Ïãú Í≤åÏûÑ Ï∂îÏ≤ú Î∞õÍ∏∞"
              }
            ]
        }
    }
    # JSON ÌòïÏãùÏúºÎ°ú Î≥ÄÌôòÌïòÏó¨ Î∞òÌôò
    return jsonify(game_dict)
# ----------------------------------------------------------------------------------------------------
# ÏÑ±Î≥Ñ ÏÑ†ÌÉù_ÎØº
# ÏÑ±Î≥Ñ ÏÑ†ÌÉù
@application.route('/step1_friend', methods=['POST'])
def step1_friend():
    response = {
        "version": "2.0",
        "template": {
            "outputs": [
                {
                    "textCard": {
                        "title": "ÏπúÍµ¨Î•º Ï∞æÏïÑÎ≥ºÍπåÏöî?",
                        "description": "Ïñ¥Îñ§ ÏπúÍµ¨Î•º Ï∞æÏïÑÎ≥ºÍπåÏöî?. \n ÏÑ±Î≥ÑÏùÑ ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî!",
                        "buttons": [
                            {
                                "action": "message",
                                "label": "Ïó¨Ïûê",
                                "messageText": "Ïó¨Ïûê"
                            },
                            {
                                "action": "message",
                                "label": "ÎÇ®Ïûê",
                                "messageText": "ÎÇ®Ïûê"
                            },
                        ]
                    }
                }
            ]
        }
    }
    return response

# ÎÇòÏù¥ÎåÄ ÏÑ†ÌÉù
@application.route('/step2_friend', methods=['POST'])
def step2_friend():
    global gender
    body = request.get_json()
    gender = body['userRequest']['utterance']  # ÏÑ±Î≥Ñ ÏÑ†ÌÉùÎêú Í∞í

    response = {
        "version": "2.0",
        "template": {
            "outputs": [
                {
                    "carousel": {
                        "type": "textCard",
                        "items": [
                            {
                                "title": "ÏπúÍµ¨Î•º Ï∞æÏïÑÎ≥ºÍπåÏöî?üíó",
                                "description": "Ïñ¥Îñ§ ÏπúÍµ¨Î•º Ï∞æÏïÑÎ≥ºÍπåÏöî?. \n ÎÇòÏù¥Î•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî!",
                                "buttons": [
                                    {
                                        "action": "message",
                                        "label": "10ÎåÄ",
                                        "messageText": "10ÎåÄ"
                                    },
                                    {
                                        "action": "message",
                                        "label": "20ÎåÄ",
                                        "messageText": "20ÎåÄ"
                                    },
                                    {
                                        "action": "message",
                                        "label": "30ÎåÄ",
                                        "messageText": "30ÎåÄ"
                                    }
                                ]
                            },
                            {
                                "title": "ÏπúÍµ¨Î•º Ï∞æÏïÑÎ≥ºÍπåÏöî?üíó",
                                "description": "Ïñ¥Îñ§ ÏπúÍµ¨Î•º Ï∞æÏïÑÎ≥ºÍπåÏöî?. \n ÎÇòÏù¥Î•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî!",
                                "buttons": [
                                    {
                                        "action": "message",
                                        "label": "40ÎåÄ",
                                        "messageText": "40ÎåÄ"
                                    },
                                    {
                                        "action": "message",
                                        "label": "50ÎåÄ",
                                        "messageText": "50ÎåÄ"
                                    }
                                ]
                            }
                        ]
                    }
                }
            ]
        }
    }
    return response

# ÏπúÍµ¨ Ï∂îÏ≤ú Í∏∞Îä•
def get_recommended_friends():
    global gender, age_group, conn
    body = request.get_json()
    age_group = body['userRequest']['utterance'].strip()  # ÎÇòÏù¥ ÏÑ†ÌÉùÎêú Í∞í

    cursor = conn.cursor()

    age_group_query = {
        '10ÎåÄ': 'age >= 10 AND age < 20',
        '20ÎåÄ': 'age >= 20 AND age < 30',
        '30ÎåÄ': 'age >= 30 AND age < 40',
        '40ÎåÄ': 'age >= 40 AND age < 50',
        '50ÎåÄ': 'age >= 50 AND age < 60'
    }.get(age_group, 'age >= 0')

    gender_query = 'F' if gender == 'Ïó¨Ïûê' else 'M'
    
    sql = "SELECT name FROM customer WHERE gender = %s AND " + age_group_query
    cursor.execute(sql, (gender_query,))
    suppliers = cursor.fetchall()

    result = [supplier[0] for supplier in suppliers][:6]
    recommended_friends = random.sample(result, len(result))

    friend_details = {}
    for name in recommended_friends:
        # Get games and age
        cursor.execute("SELECT game_name, age FROM customer WHERE name = %s", (name,))
        data = cursor.fetchone()
        if data:
            game_name, age = data
            friend_details[name] = {'games': game_name, 'age': age}

    cursor.close()
    return recommended_friends, friend_details


@application.route('/step3_friend', methods=['POST'])
def step3_friend():
    recommended_friends, friend_details = get_recommended_friends()
    return jsonify(recommended_friends, friend_details)


@application.route('/step4_friend', methods=['POST'])
def step4_friend():
    recommended_friends, friend_details = get_recommended_friends()

    items = []
    for friend in recommended_friends[:3]:
        details = friend_details[friend]
        items.append({
            "title": f"ÎãâÎÑ§ÏûÑ: {friend}",
            "description": f"# {details['games']} #{details['age']}ÏÇ¥ #{gender}",
            "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdAqmkb%2FbtsHBpCK2sR%2F5f2REVwRSQkiJ3qWkAcZkK%2Fimg.png",
            "link": {
                "web": "https://www.naver.com"
            }
        })

    responseBody = {
        "version": "2.0",
        "template": {
            "outputs": [
                {
                    "listCard": {
                        "header": {
                            "title": "ÏπúÍµ¨Î•º Ï∂îÏ≤úÌï¥Ï§ÑÍ≤å"
                        },
                        "items": items
                    }
                }
            ]
        }
    }
    return responseBody



if __name__ == "__main__":
    application.run(host='0.0.0.0', port=80)
