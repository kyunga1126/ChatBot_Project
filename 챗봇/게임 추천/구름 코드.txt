from flask import Flask, request, jsonify
import pymysql
import random

# Database connection setup
conn = pymysql.connect(
    host="13.124.40.13",
    port=53365,
    db='friendly',
    user='root',
    password='12345',
    charset='utf8mb4',
    cursorclass=pymysql.cursors.DictCursor
)


application = Flask(__name__)

# ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
step1_platform = None
step2_players = None
step3_difficulty = None
step4_category = None

gender = None
age_group = None

# ----------------------------------------------------------------------------------------------------
# ì‹œì‘ ì½”ë“œ
@application.route('/start', methods=['POST'])
def start():
    body = request.get_json()

    response = {
        "version": "2.0",
        "template": {
            "outputs": [
            {
                    "carousel": {
                        "type": "basicCard",
                        "items": [
                            {
                                "title": "ì•ˆë…•í•˜ì„¸ìš”! í”Œíˆ¬ ì±—ë´‡ì…ë‹ˆë‹¤.",
                                "description": "ë‹¤ì–‘í•œ ê¸°ëŠ¥ë“¤ì„ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤. \nì–´ë–¤ ê¸°ëŠ¥ì„ ì›í•˜ì‹œë‚˜ìš”?",
                                "thumbnail": {
                                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fc6zoNX%2FbtsHAwcwEYd%2FBh5rQbeJeg6tfDaJiKsXP1%2Fimg.png"
                                },
                                "buttons": [
                                    {
                                        "action": "message",
                                        "label": "ğŸ‘©ğŸ¼â€ğŸ¤â€ğŸ§‘ğŸ»ì¹œêµ¬ ì°¾ê¸°ğŸ‘¬",
                                        "messageText": "ì¹œêµ¬ ì°¾ê¸°"
                                    },
                                    {
                                        "action":  "message",
                                        "label": "ğŸ®ê²Œì„ ì¶”ì²œ ë°›ê¸°",
                                        "messageText": "ê²Œì„ ì¶”ì²œ ë°›ê¸°"
                                    },
                                    {
                                        "action":  "message",
                                        "label": "ğŸ’°í¬ì¸íŠ¸ ì¡°íšŒ",
                                        "messageText": "í¬ì¸íŠ¸ ì¡°íšŒ"
                                    }
                                ]
                            },
                            {
                                "title": "ì•ˆë…•í•˜ì„¸ìš”! í”Œíˆ¬ ì±—ë´‡ì…ë‹ˆë‹¤.",
                                "description": "ë‹¤ì–‘í•œ ê¸°ëŠ¥ë“¤ì„ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤. \nì–´ë–¤ ê¸°ëŠ¥ì„ ì›í•˜ì‹œë‚˜ìš”?",
                                "thumbnail": {
                                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FcjAIEb%2FbtsHB4ewzbc%2F2eQDvHDMsrlNk0xFxnhi51%2Fimg.png"
                                },
                                "buttons": [
                                    {
                                        "action": "message",
                                        "label": "ğŸ’¬ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ ë³´ê¸°",
                                        "messageText": "ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ ë³´ê¸°"
                                    },
                                    {
                                        "action":  "message",
                                        "label": "ğŸ“ë¬¸ì˜ ë° ì‹ ê³  í•˜ê¸°",
                                        "messageText": "ë¬¸ì˜ ë° ì‹ ê³  í•˜ê¸°"
                                    }
                                ]
                            }
                        ]
                    }
                }
            ]
        }
    }
    return jsonify(response)
# ----------------------------------------------------------------------------------------------------
# ê²Œì„ ì¶”ì²œ step1
@application.route('/step1_gamesuggest', methods=['POST'])
def step1_gamesuggest():
    body = request.get_json()
    
    response = {
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "textCard": {
          "title": "ì–´ëŠ í”Œë«í¼ì—ì„œ ê²Œì„ì„ ì¦ê¸°ì‹œë‚˜ìš”?",
          "description": "PC, ëª¨ë°”ì¼ ì¤‘ ì„ íƒí•´ì£¼ì„¸ìš”.",
          "buttons": [
            {
              "action": "message",
              "label": "ğŸ“ŸPCì—ì„œ ì£¼ë¡œ í•´ìš”",
              "messageText": "PC"
            },
            {
              "action": "message",
              "label": "ğŸ“±ëª¨ë°”ì¼ì—ì„œ ì£¼ë¡œ í•´ìš”",
              "messageText": "ëª¨ë°”ì¼"
            }
          ]
        }
      }
    ]
  }
}
    return jsonify(response)
# ----------------------------------------------------------------------------------------------------
# ê²Œì„ ì¶”ì²œ step2
@application.route('/step2_gamesuggest', methods=['POST'])
def step2_gamesuggest():
    global step1_platform
    body = request.get_json()
    
    # 'utterance' ê°’ ê°€ì ¸ì˜¤ê¸°
    step1_platform = body['userRequest']['utterance']
    print(f'step1_platform : {step1_platform}')
    
    response = {
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "textCard": {
          "title": "í˜¼ì í•˜ì‹œë‚˜ìš”, ì•„ë‹ˆë©´ ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ í•˜ì‹œë‚˜ìš”?",
          "buttons": [
            {
              "action": "message",
              "label": "â˜í˜¼ì ê²Œì„í•˜ê¸°",
              "messageText": "í˜¼ì"
            },
            {
              "action": "message",
              "label": "âœŒì¹œêµ¬ë“¤ê³¼ í•¨ê»˜",
              "messageText": "ë‹¤ì¤‘"
            }
          ]
        }
      }
    ]
  }
}
    return jsonify(response)
# ----------------------------------------------------------------------------------------------------
# ê²Œì„ ì¶”ì²œ step3
@application.route('/step3_gamesuggest', methods=['POST'])
def step3_gamesuggest():
    global step2_players
    body = request.get_json()
    
    # 'utterance' ê°’ ê°€ì ¸ì˜¤ê¸°
    step2_players = body['userRequest']['utterance']
    print(f'step2_players : {step2_players}')
    
    response = {
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "textCard": {
          "title": "ê²Œì„ì˜ ë‚œì´ë„ëŠ” ì–´ëŠ ì •ë„ë¥¼ ì›í•˜ì‹œë‚˜ìš”?",
          "description": "ì‰¬ì›€, ë³´í†µ, ì–´ë ¤ì›€ ì¤‘ ì„ íƒí•´ì£¼ì„¸ìš”",
          "buttons": [
            {
              "action": "message",
              "label": "ğŸ˜Šì‰¬ì›€ ë‚œì´ë„ë¡œìš”.",
              "messageText": "ì‰¬ì›€"
            },
            {
              "action": "message",
              "label": "ğŸ˜ë³´í†µ ë‚œì´ë„ë¡œìš”.",
              "messageText": "ë³´í†µ"
            },
            {
              "action": "message",
              "label": "ğŸ¤¬ì–´ë ¤ì›€ ë‚œì´ë„ë¡œìš”.",
              "messageText": "ì–´ë ¤ì›€"
            }
          ]
        }
      }
    ]
  }
}
    return jsonify(response)
# ----------------------------------------------------------------------------------------------------
# ê²Œì„ ì¶”ì²œ step4_ì¥ë¥´
@application.route('/step4_gamesuggest', methods=['POST'])
def step4_gamesuggest():
    global step3_difficulty
    body = request.get_json()
    
    # 'utterance' ê°’ ê°€ì ¸ì˜¤ê¸°
    step3_difficulty = body['userRequest']['utterance']
    print(f'step3_difficulty : {step3_difficulty}')
    
    response = {
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "carousel": {
          "type": "basicCard",
          "items": [
            {
              "title": "ì–´ë–¤ ì¥ë¥´ì˜ ê²Œì„ì„ ì„ í˜¸í•˜ì‹œë‚˜ìš”?",
              "thumbnail": {
                "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FBjhPu%2FbtsHzDCsgQ2%2F5TaUxGxVbNT4OUFzoWE5d0%2Fimg.jpg"
              },
              "buttons": [
                {
                  "action": "message",
                  "label": "ğŸ¤¼â€â™‚ï¸ì•¡ì…˜",
                  "messageText": "ì•¡ì…˜"
                },
                {
                  "action":  "message",
                  "label": "ğŸ—»ì–´ë“œë²¤ì²˜",
                  "messageText": "ì–´ë“œë²¤ì²˜"
                },
                {
                  "action":  "message",
                  "label": "ğŸ„RPG",
                  "messageText": "RPG"
                }
              ]
            },
            {
              "title": "ì–´ë–¤ ì¥ë¥´ì˜ ê²Œì„ì„ ì„ í˜¸í•˜ì‹œë‚˜ìš”?",
              "thumbnail": {
                "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbMo4yv%2FbtsHANjLtIz%2FrIjhFWDvI2xMqqiyIOthq0%2Fimg.jpg"
              },
              "buttons": [
                {
                  "action": "message",
                  "label": "ğŸ²í¼ì¦",
                  "messageText": "í¼ì¦"
                },
                {
                  "action":  "message",
                  "label": "âš½ìŠ¤í¬ì¸ ",
                  "messageText": "ìŠ¤í¬ì¸ "
                },
                {
                  "action":  "message",
                  "label": "ğŸ”«ìŠˆíŒ…",
                  "messageText": "ìŠˆíŒ…"
                }
              ]
            }
          ]
        }
      }
    ]
  }
}
    return jsonify(response)

# ----------------------------------------------------------------------------------------------------
# ê²Œì„ ì¶”ì²œ step5_SQLë¬¸ ë°˜í™˜í•˜ê¸°
@application.route('/step5_gamesuggest', methods=['POST'])
def step5_gamesuggest():
    global step1_platform, step2_players, step3_difficulty, step4_category, conn
    body = request.get_json()

    # 'utterance' ê°’ ê°€ì ¸ì˜¤ê¸°
    step4_category = body['userRequest']['utterance']
    print(f'step4_category : {step4_category}')

    # SQLë¬¸
    cursor = conn.cursor()
    sql = "SELECT * FROM gamesuggest WHERE platform = %s AND players = %s AND game_difficulty = %s AND game_category = %s"
    cursor.execute(sql, (step1_platform, step2_players, step3_difficulty, step4_category))
    suppliers = cursor.fetchall()

    # í„°ë¯¸ë„ ì¶œë ¥ í™•ì¸ìš©
    for supplier in suppliers:
        print(supplier)

    random_suppliers = random.sample(suppliers, k=3)  # suppliers ë¦¬ìŠ¤íŠ¸ì—ì„œ ëœë¤í•˜ê²Œ 3ê°œì˜ í•­ëª©ì„ ì„ íƒ

    game_dict = {
        "version": "2.0",
        "template": {
            "outputs": [
                {
                "simpleText": {
                    "text": f"ì•Œê² ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë©´ {step1_platform}ì—ì„œ {step2_players} ì¦ê¸¸ ìˆ˜ ìˆëŠ” {step3_difficulty} ë‚œì´ë„ì˜ {step4_category} ê²Œì„ì„ ì¶”ì²œí•´ë“œë¦´ê²Œìš”."
                }
            },
            {
                    "carousel": {
                        "type": "basicCard",
                        "items": [
                            {
                                "title": random_suppliers[0]['game_name'],
                                "description": f"í”Œë«í¼: {random_suppliers[0]['platform']}, ì¥ë¥´: {random_suppliers[0]['game_category']}, ë‚œì´ë„: {random_suppliers[0]['game_difficulty']}",
                                "thumbnail": {
                                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2F5is5P%2FbtsHAwvMMz5%2FyzYPVs9ywZG1cxz2bMraL0%2Fimg.png"
                                },
                                "buttons": [
                                    {
                                        "action": "webLink",
                                        "label": "ë‹¤ìš´ë¡œë“œ",
                                        "messageText": "https://chatbot.kakao.com/docs/getting-started-overview/"
                                    },
                                    {
                                        "action":  "webLink",
                                        "label": "ê²Œì„ ì‚¬ì´íŠ¸",
                                        "webLinkUrl": "https://e.kakao.com/t/hello-ryan"
                                    }
                                ]
                            },
                            {
                                "title": random_suppliers[1]['game_name'],
                                "description": f"í”Œë«í¼: {random_suppliers[1]['platform']}, ì¥ë¥´: {random_suppliers[1]['game_category']}, ë‚œì´ë„: {random_suppliers[1]['game_difficulty']}",
                                "thumbnail": {
                                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdlFnmf%2FbtsHzck2Nnj%2FAaN4sQu8NJQI521KIIpGIK%2Fimg.png"
                                },
                                "buttons": [
                                    {
                                        "action": "webLink",
                                        "label": "ë‹¤ìš´ë¡œë“œ",
                                        "messageText": "https://chatbot.kakao.com/docs/getting-started-overview/"
                                    },
                                    {
                                        "action":  "webLink",
                                        "label": "ê²Œì„ ì‚¬ì´íŠ¸",
                                        "webLinkUrl": "https://e.kakao.com/t/hello-ryan"
                                    }
                                ]
                            },
                            {
                                "title": random_suppliers[2]['game_name'],
                                "description": f"í”Œë«í¼: {random_suppliers[2]['platform']}, ì¥ë¥´: {random_suppliers[2]['game_category']}, ë‚œì´ë„: {random_suppliers[2]['game_difficulty']}",
                                "thumbnail": {
                                    "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fbz918Y%2FbtsHz7J4CBY%2Fm3vQCTxHSjqEz12eKfNEiK%2Fimg.png"
                                },
                                "buttons": [
                                    {
                                        "action": "webLink",
                                        "label": "ë‹¤ìš´ë¡œë“œ",
                                        "messageText": "https://chatbot.kakao.com/docs/getting-started-overview/"
                                    },
                                    {
                                        "action":  "webLink",
                                        "label": "ê²Œì„ ì‚¬ì´íŠ¸",
                                        "webLinkUrl": "https://e.kakao.com/t/hello-ryan"
                                    }
                                ]
                            }
                        ]
                    }
                }
            ],
            "quickReplies": [
              {
                "messageText": "ì²˜ìŒìœ¼ë¡œ",
                "action": "message",
                "label": "ì²˜ìŒìœ¼ë¡œ"
              },
              {
                "messageText": "ë‹¤ì‹œ ê²Œì„ ì¶”ì²œ ë°›ê¸°",
                "action": "message",
                "label": "ë‹¤ì‹œ ê²Œì„ ì¶”ì²œ ë°›ê¸°"
              }
            ]
        }
    }
    # JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜
    return jsonify(game_dict)
# ----------------------------------------------------------------------------------------------------
# ì„±ë³„ ì„ íƒ_ë¯¼
# ì„±ë³„ ì„ íƒ
@application.route('/step1_friend', methods=['POST'])
def step1_friend():
    response = {
        "version": "2.0",
        "template": {
            "outputs": [
                {
                    "textCard": {
                        "title": "ì¹œêµ¬ë¥¼ ì°¾ì•„ë³¼ê¹Œìš”?",
                        "description": "ì–´ë–¤ ì¹œêµ¬ë¥¼ ì°¾ì•„ë³¼ê¹Œìš”?. \n ì„±ë³„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”!",
                        "buttons": [
                            {
                                "action": "message",
                                "label": "ğŸ™‹â€â™€ï¸ì—¬ì",
                                "messageText": "ì—¬ì"
                            },
                            {
                                "action": "message",
                                "label": "ğŸ™‹â€â™‚ï¸ë‚¨ì",
                                "messageText": "ë‚¨ì"
                            },
                        ]
                    }
                }
            ]
        }
    }
    return response

# ë‚˜ì´ëŒ€ ì„ íƒ
@application.route('/step2_friend', methods=['POST'])
def step2_friend():
    global gender
    body = request.get_json()
    gender = body['userRequest']['utterance']  # ì„±ë³„ ì„ íƒëœ ê°’

    response = {
        "version": "2.0",
        "template": {
            "outputs": [
                {
                    "carousel": {
                        "type": "textCard",
                        "items": [
                            {
                                "title": "ì¹œêµ¬ë¥¼ ì°¾ì•„ë³¼ê¹Œìš”?ğŸ’—",
                                "description": "ì–´ë–¤ ì¹œêµ¬ë¥¼ ì°¾ì•„ë³¼ê¹Œìš”?. \n ë‚˜ì´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”!",
                                "buttons": [
                                    {
                                        "action": "message",
                                        "label": "ğŸ‘¶10ëŒ€",
                                        "messageText": "10ëŒ€"
                                    },
                                    {
                                        "action": "message",
                                        "label": "ğŸ‘¦20ëŒ€",
                                        "messageText": "20ëŒ€"
                                    },
                                    {
                                        "action": "message",
                                        "label": "ğŸ§‘30ëŒ€",
                                        "messageText": "30ëŒ€"
                                    }
                                ]
                            },
                            {
                                "title": "ì¹œêµ¬ë¥¼ ì°¾ì•„ë³¼ê¹Œìš”?ğŸ’—",
                                "description": "ì–´ë–¤ ì¹œêµ¬ë¥¼ ì°¾ì•„ë³¼ê¹Œìš”?. \n ë‚˜ì´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”!",
                                "buttons": [
                                    {
                                        "action": "message",
                                        "label": "ğŸ‘¨40ëŒ€",
                                        "messageText": "40ëŒ€"
                                    },
                                    {
                                        "action": "message",
                                        "label": "ğŸ‘¨â€ğŸ¦³50ëŒ€",
                                        "messageText": "50ëŒ€"
                                    }
                                ]
                            }
                        ]
                    }
                }
            ]
        }
    }
    return response

# ì¹œêµ¬ ì¶”ì²œ ê¸°ëŠ¥
def get_recommended_friends():
    global gender, age_group, conn
    body = request.get_json()
    age_group = body['userRequest']['utterance'].strip()  # ë‚˜ì´ ì„ íƒëœ ê°’

    cursor = conn.cursor()

    # age_groupë¥¼ SQLì— ë“¤ì–´ê°ˆ ë¬¸ì¥ìœ¼ë¡œ ë³€í™˜
    age_group_query = {
        '10ëŒ€': 'age >= 10 AND age < 20',
        '20ëŒ€': 'age >= 20 AND age < 30',
        '30ëŒ€': 'age >= 30 AND age < 40',
        '40ëŒ€': 'age >= 40 AND age < 50',
        '50ëŒ€': 'age >= 50 AND age < 60'
    }.get(age_group, 'age >= 0')

    gender_query = 'F' if gender == 'ì—¬ì' else 'M'
    
    sql = "SELECT * FROM customer WHERE gender = %s AND " + age_group_query
    cursor.execute(sql, (gender_query,))
    suppliers = cursor.fetchall()

    result = [supplier['name'] for supplier in suppliers][:6]
    recommended_friends = random.sample(result, len(result))
    
    # í„°ë¯¸ë„ ì¶œë ¥ í™•ì¸ìš©
    for supplier in suppliers:
        print(supplier)
        
    friend_details = {}
    for name in recommended_friends:
        # Get games and age
        cursor.execute("SELECT game_name, age FROM customer WHERE name = %s", (name,))
        data = cursor.fetchone()
        if data:
            game_name, age = data['game_name'], data['age']
            friend_details[name] = {'games': game_name, 'age': age}

    cursor.close()
    return recommended_friends, friend_details


@application.route('/step4_friend', methods=['POST'])
def step4_friend():
    recommended_friends, friend_details = get_recommended_friends()

    items = []
    for friend in recommended_friends[:3]:
        details = friend_details[friend]
        items.append({
            "title": f"ë‹‰ë„¤ì„: {friend}",
            "description": f"# {details['games']} #{details['age']}ì‚´ #{gender}",
            "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdAqmkb%2FbtsHBpCK2sR%2F5f2REVwRSQkiJ3qWkAcZkK%2Fimg.png",
            "link": {
                "web": "https://www.naver.com"
            }
        })

    responseBody = {
        "version": "2.0",
        "template": {
            "outputs": [
                {
                    "listCard": {
                        "header": {
                            "title": "ì¹œêµ¬ë¥¼ ì¶”ì²œí•´ì¤„ê²Œ"
                        },
                        "items": items
                    }
                }
            ],
            "quickReplies": [
              {
                "messageText": "ì²˜ìŒìœ¼ë¡œ",
                "action": "message",
                "label": "ì²˜ìŒìœ¼ë¡œ"
              },
              {
                "messageText": "ë‹¤ì‹œ ì¹œêµ¬ ì¶”ì²œ ë°›ê¸°",
                "action": "message",
                "label": "ë‹¤ì‹œ ì¹œêµ¬ ì¶”ì²œ ë°›ê¸°"
              }
            ]
        }
    }
    return responseBody



if __name__ == "__main__":
    application.run(host='0.0.0.0', port=80)
