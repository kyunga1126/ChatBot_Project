# flaskì— ìˆëŠ” requestì™€ Bluepoint í˜¸ì¶œ
from flask import Flask, request, jsonify, Blueprint
import pymysql
import random

# Database connection setup
conn = pymysql.connect(
    host="52.78.100.77",
    port=54201,
    db='friendly',
    user='root',
    password='12345',
    charset='utf8mb4',
    cursorclass=pymysql.cursors.DictCursor
)


application = Flask(__name__)

# ë¸”ë£¨í”„ë¦°íŠ¸ ê°ì²´ ë“±ë¡
bp = Blueprint('pltoo_recommend', __name__, url_prefix='/')


# ì „ì—­ ë³€ìˆ˜ ì„ ì–¸

gender = None
age_group = None


# ì„±ë³„ ì„ íƒ_ë¯¼

#url ì„¤ì •
@bp.route('/step1_friend', methods=['POST'])
def step1_friend():
    response = {
        "version": "2.0",
        "template": {
            "outputs": [
                {
                    "textCard": {
                        "title": "ì¹œêµ¬ë¥¼ ì°¾ì•„ë³¼ê¹Œìš”?",
                        "description": "ì–´ë–¤ ì¹œêµ¬ë¥¼ ì°¾ì•„ë³¼ê¹Œìš”?. \n ì„±ë³„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”!",
                        "buttons": [
                            {
                                "action": "message",
                                "label": "ì—¬ì",
                                "messageText": "ì—¬ì"
                            },
                            {
                                "action": "message",
                                "label": "ë‚¨ì",
                                "messageText": "ë‚¨ì"
                            },
                        ]
                    }
                }
            ]
        }
    }
    return response

# ë‚˜ì´ëŒ€ ì„ íƒ
@bp.route('/step2_friend', methods=['POST'])
def step2_friend():
    global gender
    body = request.get_json()
    gender = body['userRequest']['utterance']  # ì„±ë³„ ì„ íƒëœ ê°’

    response = {
        "version": "2.0",
        "template": {
            "outputs": [
                {
                    "carousel": {
                        "type": "textCard",
                        "items": [
                            {
                                "title": "ì¹œêµ¬ë¥¼ ì°¾ì•„ë³¼ê¹Œìš”?ğŸ’—",
                                "description": "ì–´ë–¤ ì¹œêµ¬ë¥¼ ì°¾ì•„ë³¼ê¹Œìš”?. \n ë‚˜ì´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”!",
                                "buttons": [
                                    {
                                        "action": "message",
                                        "label": "10ëŒ€",
                                        "messageText": "10ëŒ€"
                                    },
                                    {
                                        "action": "message",
                                        "label": "20ëŒ€",
                                        "messageText": "20ëŒ€"
                                    },
                                    {
                                        "action": "message",
                                        "label": "30ëŒ€",
                                        "messageText": "30ëŒ€"
                                    }
                                ]
                            },
                            {
                                "title": "ì¹œêµ¬ë¥¼ ì°¾ì•„ë³¼ê¹Œìš”?ğŸ’—",
                                "description": "ì–´ë–¤ ì¹œêµ¬ë¥¼ ì°¾ì•„ë³¼ê¹Œìš”?. \n ë‚˜ì´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”!",
                                "buttons": [
                                    {
                                        "action": "message",
                                        "label": "40ëŒ€",
                                        "messageText": "40ëŒ€"
                                    },
                                    {
                                        "action": "message",
                                        "label": "50ëŒ€",
                                        "messageText": "50ëŒ€"
                                    }
                                ]
                            }
                        ]
                    }
                }
            ]
        }
    }
    return response

# ì¹œêµ¬ ì¶”ì²œ ê¸°ëŠ¥
def get_recommended_friends():
    
    # ì „ì—­ë³€ìˆ˜ ì„ ì–¸
    global gender, age_group, conn
    
    # HTTP ìš”ì²­ì˜ ë³¸ë¬¸ì„ JSON í˜•ì‹ìœ¼ë¡œ íŒŒì‹±í•˜ì—¬ body ë³€ìˆ˜ì— ì €ì¥
    body = request.get_json()
    
    
    age_group = body['userRequest']['utterance'].strip()  # ë‚˜ì´ ì„ íƒëœ ê°’

    cursor = conn.cursor()

    # ë‚˜ì´ëŒ€ë¥¼ í‚¤(key)ë¡œ í•˜ê³ , ê° ë‚˜ì´ëŒ€ì— ëŒ€í•œ SQL ì¡°ê±´ë¬¸ì„ ê°’(value)ìœ¼ë¡œ ê°–ê³ ìˆë‹¤.
    age_group_query = {
        '10ëŒ€': 'age >= 10 AND age < 20',
        '20ëŒ€': 'age >= 20 AND age < 30',
        '30ëŒ€': 'age >= 30 AND age < 40',
        '40ëŒ€': 'age >= 40 AND age < 50',
        '50ëŒ€': 'age >= 50 AND age < 60'
    }.get(age_group, 'age >= 0')

    gender_query = 'F' if gender == 'ì—¬ì' else 'M'

    # ê³ ê°ì˜ ì´ë¦„(name), ê²Œì„ ì´ë¦„(game_name), ë‚˜ì´(age)ë¥¼ ì„ íƒí•˜ëŠ” ì¿¼ë¦¬
    sql = "SELECT name, game_name, age FROM customer WHERE gender = %s AND " + age_group_query
    cursor.execute(sql, (gender_query,))
    
    #ë°ì´í„° ë³€ìˆ˜ì— ëª¨ë‘ ì €ì¥
    data = cursor.fetchall()

    # dataì˜ ìš”ì†Œë“¤ì„ ë¬´ì‘ìœ„ë¡œ ì„ì€ ìƒˆë¡œìš´ ë¦¬ìŠ¤íŠ¸
    recommended_friends = random.sample(data, len(data))

    # ê³ ê°ì˜ ì´ë¦„ì„ í‚¤ë¡œ, ê²Œì„ì´ë¦„ê³¼ ë‚˜ì´ë¥¼ ê°’ìœ¼ë¡œ í•˜ëŠ” ë”•ì…”ë„ˆë¦¬ ìƒì„±
    friend_details = {person['name']: {'games': person['game_name'], 'age': person['age']} for person in recommended_friends}

    cursor.close()
    
    # ë‘ê°œì˜ ê°’ì„ ë°˜í™˜
    #1. recommended_friends ë¦¬ìŠ¤íŠ¸ì—ì„œ ê° ê³ ê°ì˜ ì´ë¦„ì„ ì¶”ì¶œí•œ ë¦¬ìŠ¤íŠ¸
    #2. ê³ ê°ì˜ ìƒì„¸ ì •ë³´ë¥¼ ë‹´ê³  ìˆëŠ” friend_details ë”•ì…”ë„ˆë¦¬
    return [person['name'] for person in recommended_friends], friend_details



@bp.route('/step4_friend', methods=['POST'])
def step4_friend():
    recommended_friends, friend_details = get_recommended_friends()

    items = []
    for friend in recommended_friends[:3]:
        details = friend_details[friend]
        items.append({
            "title": f"ë‹‰ë„¤ì„: {friend}",
            "description": f"# {details['games']} #{details['age']}ì‚´ #{gender}",
            "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdAqmkb%2FbtsHBpCK2sR%2F5f2REVwRSQkiJ3qWkAcZkK%2Fimg.png",
            "link": {
                "web": "https://www.naver.com"
            }
        })

    responseBody = {
        "version": "2.0",
        "template": {
            "outputs": [
                {
                    "listCard": {
                        "header": {
                            "title": "ì¹œêµ¬ë¥¼ ì¶”ì²œí•´ì¤„ê²Œ"
                        },
                        "items": items
                    }
                }
            ]
        }
    }
    return responseBody

